#!/usr/bin/env bash
# 
# Beehive one-shot bootstrap/startup script
# > Run once: ./start-beehive [options]
# > Idempotent (safe to re-run; won't duplicate resources)
#
# Options: 
#   - **All options are passed to tools setup script** (tools/scripts/set-up-tools.sh)
#   - For full option list, run `tools/scripts/set-up-tools.sh --help`
#
# Prerequisites: Node.js, Python 3.8+, git
#
# Detection: 
#   Automatically configures any CLI whose user-scoped config directory exists (at paths listed):
#   - Claude Code: ~/.claude/
#   - Gemini CLI:  ~/.gemini/
#   - Codex:       ~/.codex/

set -euo pipefail

GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'        # no colour

# Change to repo root
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$REPO_ROOT" || exit 1

# Source agent selection library
source "$REPO_ROOT/scripts/lib/agent-selection.sh"

echo -e "${BLUE}====================================================${NC}"
echo -e "${BLUE}  Beehive: user-scoped bootstrap setup${NC}"
echo -e "${BLUE}====================================================${NC}"
echo ""

# Detect installed CLIs (exits if none found, logs detected CLIs)
discover_agents
echo ""

# --- Run setup scripts (all use directory-based detection) ---

# Run agent setup: 
#   - Wires role prompts into correct locations 
#   - Creates commands and launcher wrappers for directlybusing agents in a main conversation 
#     (i.e. as opposed to as isolated subagents)
# Note: Must be run before tools setup since the agent files mentioned by the Zen 
#   configs must exist when Zen is started up
echo ""
echo -e "${BLUE}Setting up agents and agent launchers/slash commands...${NC}"
echo ""
agents/scripts/set-up-agents.sh

# Run tools setup & startup, passing along CLI options received
#   - Configures MCPs for each supported coding CLI
#   - Launches MCPs servers and backing containers (for those run as local HTTP servers)
echo -e "${BLUE}Setting up tools...${NC}"
echo ""
tools/scripts/set-up-tools.sh "$@"

# Run configs setup:
#   - Generate coding CLIs' context/config files (w/ device-specific abs paths) 
#   - Symlinks them to the appropriate user-scoped locations for each agent
echo ""
echo -e "${BLUE}Setting up config files...${NC}"
echo ""
configs/scripts/set-up-configs.sh

echo ""
echo -e "${GREEN}==========================================================${NC}"
echo -e "${GREEN}  Bootstrapping complete: Beehive is ready to use.${NC}"
echo -e "${GREEN}==========================================================${NC}"
echo ""
echo "To add or remove CLIs in the future:"
echo "  - Add: Create user-scoped config directory (e.g., mkdir -p ~/.gemini)"
echo "  - Remove: Delete user-scoped config directory (e.g., rm -rf ~/.codex)"
echo "  - Then re-run: ./scripts/start-beehive"
echo ""
