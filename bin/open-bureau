#!/usr/bin/env bash
# 
# Bureau one-shot bootstrap/startup script
# > Run once: ./open-bureau
# > Idempotent (safe to re-run; won't duplicate or kill running resources)
#
# For configuration details, see docs/CONFIGURATION.md

set -euo pipefail

GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'        # no colour

# Change to repo root
REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$REPO_ROOT" || exit 1

# Check dependencies, install correct Python version packages and set up env
bin/check-prereqs

# Source agent selection library
source "$REPO_ROOT/bin/lib/agent-selection.sh"

echo -e "${BLUE}====================================================${NC}"
echo -e "${BLUE}  Bureau bootstrap & startup${NC}"
echo -e "${BLUE}====================================================${NC}"
echo ""

# Determine enabled agents from config
discover_agents
echo ""

# Run cleanup if not run recently (silent, non-blocking)
# Note: --quiet suppresses stdout, but stderr (errors) still shows
if command -v uv &> /dev/null; then
    uv run sweep --quiet || true
fi

# --- Run setup scripts (all use directory-based detection) ---

# Run agent setup: 
#   - Wires role prompts into correct locations 
#   - Creates commands and launcher wrappers for directlybusing agents in a main conversation 
#     (i.e. as opposed to as isolated subagents)
# Note: Must be run before tools setup since the agent files mentioned by the PAL
#   configs must exist when PAL is started up
echo ""
echo -e "${BLUE}Setting up agents and agent launchers/slash commands...${NC}"
echo ""
agents/scripts/set-up-agents.sh

# Run tools setup & startup, passing along CLI options received
#   - Configures MCPs for each supported coding CLI
#   - Launches MCPs servers and backing containers (for those run as local HTTP servers)
echo -e "${BLUE}Setting up tools...${NC}"
echo ""
tools/scripts/set-up-tools.sh "$@"

# Run configs setup:
#   - Generate coding CLIs' context/config files (w/ device-specific abs paths) 
#   - Symlinks them to the appropriate user-scoped locations for each agent
echo ""
echo -e "${BLUE}Setting up config files...${NC}"
echo ""
protocols/scripts/set-up-configs.sh

echo ""
echo -e "${GREEN}==========================================================${NC}"
echo -e "${GREEN}  Bootstrapping complete: Bureau is ready to use.${NC}"
echo -e "${GREEN}==========================================================${NC}"
echo ""
echo "To add or remove CLIs in the future:"
echo "  - Add: Create user-scoped config directory (e.g., mkdir -p ~/.gemini)"
echo "  - Remove: Delete user-scoped config directory (e.g., rm -rf ~/.codex)"
echo "  - Then re-run: ./bin/open-bureau"
echo ""
